# #4 Documento de Aprendizaje - Express.js y Arquitectura del Backend

## ðŸ“‹ Ãndice
1. Â¿QuÃ© es Express.js?
2. Conceptos BÃ¡sicos de Express
3. Middleware - El CorazÃ³n de Express
4. Rutas (Routes)
5. Arquitectura MVC
6. CORS - Permitir Frontend
7. AnÃ¡lisis del server.js de la App
8. Ejemplo Completo

---

## 1. Â¿QuÃ© es Express.js?

**Express** es un **framework minimalista** para crear servidores web y APIs en Node.js.

### Sin Express (Node.js puro)

```javascript
// âŒ Muy verboso y complicado
import http from 'http';

const server = http.createServer((req, res) => {
  if (req.url === '/api/pedidos' && req.method === 'GET') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ pedidos: [] }));
  } else if (req.url === '/api/pedidos' && req.method === 'POST') {
    // CÃ³digo complicado para parsear body...
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

server.listen(3001);
```

### Con Express

```javascript
// âœ… Simple y elegante
import express from 'express';

const app = express();

app.get('/api/pedidos', (req, res) => {
  res.json({ pedidos: [] });
});

app.post('/api/pedidos', (req, res) => {
  // Body ya parseado automÃ¡ticamente
  const pedido = req.body;
  res.json({ success: true });
});

app.listen(3001);
```

---

## 2. Conceptos BÃ¡sicos de Express

### Crear una AplicaciÃ³n Express

```javascript
import express from 'express';

// Crear instancia de Express
const app = express();

// app es el objeto principal que gestiona todo
```

### Request y Response

```
CLIENTE                           SERVIDOR
  â”‚                                  â”‚
  â”‚  â”€â”€â”€â”€ HTTP Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
  â”‚         (req)                     â”‚
  â”‚                                   â”‚
  â”‚                          Procesar request
  â”‚                          (tu cÃ³digo)
  â”‚                                   â”‚
  â”‚  â—„â”€â”€â”€â”€ HTTP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
  â”‚         (res)                     â”‚
  â”‚                                   â”‚
```

#### Request (req) - Lo que RECIBE el servidor

```javascript
app.get('/api/pedidos/:id', (req, res) => {
  // ParÃ¡metros de URL
  const id = req.params.id;           // /api/pedidos/123 â†’ '123'

  // Query strings
  const filtro = req.query.estado;    // ?estado=pendiente â†’ 'pendiente'

  // Headers
  const token = req.headers.authorization; // 'Bearer abc123'

  // Body (POST/PUT)
  const data = req.body;              // { descripcion: '...' }

  // Usuario autenticado (aÃ±adido por middleware)
  const userId = req.user.id;
});
```

#### Response (res) - Lo que DEVUELVE el servidor

```javascript
app.get('/api/pedidos', (req, res) => {
  // JSON (mÃ¡s comÃºn)
  res.json({ pedidos: [] });

  // Texto plano
  res.send('Hola mundo');

  // CÃ³digo de estado personalizado
  res.status(404).json({ error: 'No encontrado' });

  // Redirigir
  res.redirect('/login');
});
```

### CÃ³digos de Estado HTTP

```
200 OK                 â†’ Ã‰xito
201 Created            â†’ Recurso creado
400 Bad Request        â†’ Datos invÃ¡lidos
401 Unauthorized       â†’ No autenticado (sin token)
403 Forbidden          â†’ No autorizado (sin permisos)
404 Not Found          â†’ Recurso no existe
500 Internal Error     â†’ Error del servidor
```

**Ejemplo:**

```javascript
app.post('/api/pedidos', async (req, res) => {
  try {
    const pedido = await crearPedido(req.body);
    res.status(201).json({ pedido });  // 201 = creado
  } catch (error) {
    res.status(500).json({ error: 'Error del servidor' });
  }
});
```

---

## 3. Middleware - El CorazÃ³n de Express

### Â¿QuÃ© es un Middleware?

Un **middleware** es una **funciÃ³n que intercepta el request** antes de llegar a la ruta final.

```
Cliente â”€â”€â–º Middleware 1 â”€â”€â–º Middleware 2 â”€â”€â–º Ruta â”€â”€â–º Respuesta
              â†“                  â†“              â†“
           Logging           Parsear         LÃ³gica
                             JSON           de negocio
```

### AnatomÃ­a de un Middleware

```javascript
function miMiddleware(req, res, next) {
  // 1. Hacer algo con req o res
  console.log('Request recibido');

  // 2. Pasar al siguiente middleware
  next();

  // Si no llamas next(), la peticiÃ³n se DETIENE aquÃ­
}

// Usar middleware
app.use(miMiddleware);
```

### Tipos de Middleware

#### 1. Middleware de AplicaciÃ³n (app.use)

```javascript
// Se ejecuta para TODAS las rutas
app.use((req, res, next) => {
  console.log(`${req.method} ${req.path}`);
  next();
});
```

#### 2. Middleware de Ruta

```javascript
// Solo para esta ruta especÃ­fica
app.get('/api/pedidos', miMiddleware, (req, res) => {
  res.json({ pedidos: [] });
});
```

#### 3. Middleware de Error

```javascript
// Maneja errores (4 parÃ¡metros)
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).json({ error: 'Error del servidor' });
});
```

### Middleware Comunes en la App

#### express.json() - Parsear JSON

```javascript
// backend/server.js

// Sin este middleware
app.post('/api/pedidos', (req, res) => {
  console.log(req.body);  // undefined
});

// Con este middleware
app.use(express.json());

app.post('/api/pedidos', (req, res) => {
  console.log(req.body);  // { descripcion: '...', cantidad: 5 }
});
```

**QuÃ© hace:**
- Parsea el body JSON del request
- Convierte string â†’ objeto JavaScript
- Guarda resultado en `req.body`

#### express.static() - Servir Archivos

```javascript
// backend/server.js

import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Servir imÃ¡genes
app.use('/uploads', express.static(join(__dirname, 'uploads')));
```

**QuÃ© hace:**
- Hace accesibles archivos estÃ¡ticos
- `http://localhost:3001/uploads/foto1.jpg` â†’ `backend/uploads/foto1.jpg`

#### Logging Middleware (Personalizado)

```javascript
// backend/server.js

app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});
```

**Resultado:**
```
2024-01-15T10:30:45.123Z - GET /api/pedidos
2024-01-15T10:30:47.456Z - POST /api/pedidos
```

---

## 4. Rutas (Routes)

### Rutas BÃ¡sicas

```javascript
// GET - Obtener datos
app.get('/api/pedidos', (req, res) => {
  res.json({ pedidos: [] });
});

// POST - Crear datos
app.post('/api/pedidos', (req, res) => {
  const pedido = req.body;
  res.status(201).json({ pedido });
});

// PUT - Actualizar datos
app.put('/api/pedidos/:id', (req, res) => {
  const id = req.params.id;
  const data = req.body;
  res.json({ id, data });
});

// DELETE - Eliminar datos
app.delete('/api/pedidos/:id', (req, res) => {
  const id = req.params.id;
  res.json({ mensaje: 'Eliminado', id });
});
```

### ParÃ¡metros de Ruta

```javascript
// :id es un parÃ¡metro dinÃ¡mico
app.get('/api/pedidos/:id', (req, res) => {
  const id = req.params.id;

  // GET /api/pedidos/123 â†’ id = '123'
  // GET /api/pedidos/456 â†’ id = '456'

  res.json({ id });
});

// MÃºltiples parÃ¡metros
app.get('/api/clientes/:clienteId/obras/:obraId', (req, res) => {
  const { clienteId, obraId } = req.params;

  // GET /api/clientes/5/obras/10
  // â†’ clienteId = '5', obraId = '10'

  res.json({ clienteId, obraId });
});
```

### Query Strings

```javascript
app.get('/api/pedidos', (req, res) => {
  const { estado, urgente, page } = req.query;

  // GET /api/pedidos?estado=pendiente&urgente=true&page=2
  // â†’ estado = 'pendiente'
  // â†’ urgente = 'true' (string!)
  // â†’ page = '2' (string!)

  res.json({ estado, urgente, page });
});
```

### Separar Rutas en Archivos (Router)

```javascript
// backend/routes/pedidos.js

import express from 'express';

// Crear router
const router = express.Router();

// Definir rutas (sin /api/pedidos)
router.get('/', (req, res) => {
  res.json({ pedidos: [] });
});

router.post('/', (req, res) => {
  res.json({ success: true });
});

router.put('/:id', (req, res) => {
  res.json({ id: req.params.id });
});

// Exportar router
export default router;
```

```javascript
// backend/server.js

import pedidosRoutes from './routes/pedidos.js';

// Montar router en prefijo /api/pedidos
app.use('/api/pedidos', pedidosRoutes);

// Ahora:
// GET /api/pedidos      â†’ router.get('/')
// POST /api/pedidos     â†’ router.post('/')
// PUT /api/pedidos/:id  â†’ router.put('/:id')
```

---

## 5. Arquitectura MVC

### Â¿QuÃ© es MVC?

**Model-View-Controller** es un patrÃ³n para organizar cÃ³digo:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENTE (Frontend)                     â”‚
â”‚  EnvÃ­a request a /api/pedidos           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROUTES (Rutas)                         â”‚
â”‚  Define endpoints y middlewares         â”‚
â”‚  routes/pedidos.js                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER (Controlador)               â”‚
â”‚  LÃ³gica de negocio                      â”‚
â”‚  controllers/pedidosController.js       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MODEL (Modelo)                         â”‚
â”‚  Acceso a base de datos                 â”‚
â”‚  config/database.js                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ejemplo Completo MVC

#### 1. Route (Ruta)

```javascript
// backend/routes/pedidos.js

import express from 'express';
import { authenticateToken } from '../middleware/auth.js';
import * as pedidosController from '../controllers/pedidosController.js';

const router = express.Router();

// Definir ruta con middleware y controller
router.get('/',
  authenticateToken,              // Middleware de autenticaciÃ³n
  pedidosController.getPedidos    // Controller
);

router.post('/',
  authenticateToken,
  pedidosController.createPedido
);

export default router;
```

#### 2. Controller (Controlador)

```javascript
// backend/controllers/pedidosController.js

import db from '../config/database.js';

// Obtener pedidos
export const getPedidos = async (req, res) => {
  try {
    const userId = req.user.id;
    const userRole = req.user.rol;

    // LÃ³gica de negocio
    let query = 'SELECT * FROM pedidos';

    if (userRole !== 'admin') {
      query += ' WHERE usuario_id = ?';
    }

    // Llamar a la base de datos (Model)
    const pedidos = db.prepare(query).all(userRole === 'admin' ? [] : [userId]);

    res.json({ pedidos });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Error del servidor' });
  }
};

// Crear pedido
export const createPedido = async (req, res) => {
  try {
    const { descripcion, cantidad, obra_id } = req.body;
    const userId = req.user.id;

    // LÃ³gica de negocio: validar datos
    if (!descripcion || !cantidad) {
      return res.status(400).json({ error: 'Datos incompletos' });
    }

    // Insertar en BD (Model)
    const result = db.prepare(`
      INSERT INTO pedidos (descripcion, cantidad, obra_id, solicitante_id, estado)
      VALUES (?, ?, ?, ?, ?)
    `).run(descripcion, cantidad, obra_id, userId, 'Registrado');

    res.status(201).json({ id: result.lastInsertRowid });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Error al crear pedido' });
  }
};
```

#### 3. Model (Base de Datos)

```javascript
// backend/config/database.js

import initSqlJs from 'sql.js';

let db;

export async function initDatabase() {
  const SQL = await initSqlJs();
  db = new SQL.Database();

  // Crear tablas
  db.exec(`
    CREATE TABLE IF NOT EXISTS pedidos (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      descripcion TEXT NOT NULL,
      cantidad INTEGER NOT NULL,
      obra_id INTEGER,
      solicitante_id INTEGER NOT NULL,
      estado TEXT DEFAULT 'Registrado',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);
}

// Funciones de acceso a BD
export function prepare(sql) {
  return db.prepare(sql);
}

export default { prepare };
```

---

## 6. CORS - Permitir Frontend

### Â¿QuÃ© es CORS?

**Cross-Origin Resource Sharing** - Permite que el frontend (puerto 5173) acceda al backend (puerto 3001).

### El Problema

```
Frontend: http://localhost:5173
Backend:  http://localhost:3001

âŒ Sin CORS:
   Frontend hace fetch a backend â†’ BLOQUEADO por el navegador
   Error: "Access-Control-Allow-Origin"

âœ… Con CORS:
   Backend dice: "Permito requests desde localhost:5173"
   â†’ Fetch funciona âœ“
```

### Configurar CORS

```javascript
// backend/server.js

import cors from 'cors';

// ConfiguraciÃ³n simple (desarrollo)
app.use(cors());  // Permite TODOS los orÃ­genes

// ConfiguraciÃ³n avanzada (producciÃ³n)
const allowedOrigins = [
  'http://localhost:5173',        // Desarrollo
  'https://mi-app.com'            // ProducciÃ³n
];

app.use(cors({
  origin: function (origin, callback) {
    // Permitir requests sin origin (mobile apps, curl)
    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);  // Permitido
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true  // Permitir cookies/auth headers
}));
```

### CORS en la App

```javascript
// backend/server.js

const allowedOrigins = [
  'http://localhost:5173',
  process.env.FRONTEND_URL  // https://pagina-solpeds.com
].filter(Boolean);

app.use(cors({
  origin: function (origin, callback) {
    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1 || NODE_ENV === 'development') {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));
```

---

## 7. AnÃ¡lisis del server.js de la App

```javascript
// backend/server.js

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { initDatabase } from './config/database.js';

// Importar rutas
import authRoutes from './routes/auth.js';
import pedidosRoutes from './routes/pedidos.js';
import comprasRoutes from './routes/compras.js';
import notificacionesRoutes from './routes/notificaciones.js';
import centrosCostoRoutes from './routes/centrosCosto.js';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. CONFIGURACIÃ“N INICIAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Cargar variables de entorno (.env)
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;
const NODE_ENV = process.env.NODE_ENV || 'development';

// Inicializar base de datos
await initDatabase();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2. MIDDLEWARES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// CORS - Permitir frontend
const allowedOrigins = [
  'http://localhost:5173',
  process.env.FRONTEND_URL
].filter(Boolean);

app.use(cors({
  origin: function (origin, callback) {
    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1 || NODE_ENV === 'development') {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));

// Parsear JSON
app.use(express.json());

// Parsear URL-encoded (formularios)
app.use(express.urlencoded({ extended: true }));

// Servir archivos estÃ¡ticos (imÃ¡genes)
app.use('/uploads', express.static(join(__dirname, 'uploads')));

// Logging personalizado
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3. RUTAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app.use('/api/auth', authRoutes);
app.use('/api/pedidos', pedidosRoutes);
app.use('/api/compras', comprasRoutes);
app.use('/api/notificaciones', notificacionesRoutes);
app.use('/api/centros-costo', centrosCostoRoutes);

// Ruta de health check
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    message: 'Servidor funcionando correctamente',
    env: NODE_ENV
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4. MANEJO DE ERRORES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// 404 - Ruta no encontrada
app.use((req, res) => {
  res.status(404).json({ error: 'Ruta no encontrada' });
});

// 500 - Error del servidor
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({ error: 'Error interno del servidor' });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5. INICIAR SERVIDOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ðŸš€ Servidor Backend iniciado               â•‘
â•‘   ðŸŒ Entorno: ${NODE_ENV}                    â•‘
â•‘   ðŸ“¡ http://localhost:${PORT}                â•‘
â•‘   ðŸ“Š Base de datos: SQLite                   â•‘
â•‘   ðŸ” AutenticaciÃ³n: JWT                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

export default app;
```

---

## 8. Ejemplo Completo: Crear Endpoint

### Objetivo: Crear endpoint GET /api/pedidos/:id

#### Paso 1: Crear Controller

```javascript
// backend/controllers/pedidosController.js

import db from '../config/database.js';

export const getPedidoById = async (req, res) => {
  try {
    const { id } = req.params;
    const userId = req.user.id;
    const userRole = req.user.rol;

    // Buscar pedido
    const pedido = db.prepare('SELECT * FROM pedidos WHERE id = ?').get(id);

    if (!pedido) {
      return res.status(404).json({ error: 'Pedido no encontrado' });
    }

    // Verificar permisos
    if (userRole !== 'admin' && pedido.solicitante_id !== userId) {
      return res.status(403).json({ error: 'No tienes permiso' });
    }

    res.json({ pedido });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Error del servidor' });
  }
};
```

#### Paso 2: Agregar Ruta

```javascript
// backend/routes/pedidos.js

import express from 'express';
import { authenticateToken } from '../middleware/auth.js';
import * as pedidosController from '../controllers/pedidosController.js';

const router = express.Router();

// Nueva ruta
router.get('/:id', authenticateToken, pedidosController.getPedidoById);

export default router;
```

#### Paso 3: Probar

```bash
# Con curl
curl http://localhost:3001/api/pedidos/123 \
  -H "Authorization: Bearer tu-token-aqui"

# Respuesta:
{
  "pedido": {
    "id": 123,
    "descripcion": "Cemento",
    "cantidad": 50,
    "estado": "Registrado"
  }
}
```

---

**ðŸ“Œ ContinÃºa con:** [#5 - SQLite y Base de Datos](#)
